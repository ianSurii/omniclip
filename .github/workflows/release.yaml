# /**
#  * @author [Ian Muthuri]
#  * @email [ian,muthuri@outlook.com]
#  * @create date 2025-12-16 19:02:17
#  * @modify date 2025-12-16 19:02:58
#  * @desc [Release workflow for building Flutter application for Android, Web, Linux, and Windows platforms.]
#  */
name: Flutter Release Build

on:
  push:
    # branches:
    #   - main
    #   - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  version:
    name: Create version number
    runs-on: ubuntu-latest
    outputs:
      version-number: ${{ steps.version.outputs.VERSION_NUMBER }}
      build-number: ${{ steps.version.outputs.BUILD_NUMBER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0"
          fi
          BUILD_NUMBER="${{ github.run_number }}"
          echo "VERSION_NUMBER=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION+$BUILD_NUMBER"

  build-android:
    name: Build Android
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Decode keystore from secret
        run: |
          echo "${{ secrets.OMNICLIP_KEYSTORE_BASE64 }}" | base64 -d > android/omniclip.keystore

      - name: Create key.properties
        run: |
          echo "storeFile=../omniclip.keystore" > android/key.properties
          echo "storePassword=${{ secrets.OMNICLIP_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.OMNICLIP_KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.OMNICLIP_KEY_PASSWORD }}" >> android/key.properties

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release --build-name=${{ needs.version.outputs.version-number }} --build-number=${{ needs.version.outputs.build-number }}

      - name: Build Android App Bundle
        run: flutter build appbundle --release --build-name=${{ needs.version.outputs.version-number }} --build-number=${{ needs.version.outputs.build-number }}

      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/centra-v${{ needs.version.outputs.version-number }}-android.apk

      - name: Rename AAB
        run: |
          mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/centra-v${{ needs.version.outputs.version-number }}-android.aab

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/centra-v${{ needs.version.outputs.version-number }}-android.apk

      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/centra-v${{ needs.version.outputs.version-number }}-android.aab

  build-web:
    name: Build Web
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release

      - name: Archive web build
        run: |
          cd build/web
          zip -r ../../centra-v${{ needs.version.outputs.version-number }}-web.zip .
          cd ../..

      - name: Upload Web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: centra-v${{ needs.version.outputs.version-number }}-web.zip

  build-linux:
    name: Build Linux DEB
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev dpkg-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create DEB package structure
        run: |
          VERSION="${{ needs.version.outputs.version-number }}"
          BUILD_NUMBER="${{ needs.version.outputs.build-number }}"
          PACKAGE_NAME="centra_${VERSION}-${BUILD_NUMBER}_amd64"
          
          mkdir -p "$PACKAGE_NAME/DEBIAN"
          mkdir -p "$PACKAGE_NAME/usr/local/bin/centra"
          mkdir -p "$PACKAGE_NAME/usr/share/applications"
          mkdir -p "$PACKAGE_NAME/usr/share/icons/hicolor/256x256/apps"
          
          # Copy application files
          cp -r build/linux/x64/release/bundle/* "$PACKAGE_NAME/usr/local/bin/centra/"
          
          # Create control file
          cat > "$PACKAGE_NAME/DEBIAN/control" << EOF
          Package: centra
          Version: ${VERSION}-${BUILD_NUMBER}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Erevu Technologies <support@erevu.com>
          Description: Centra Application
           A Flutter-based application for payroll and HR management.
          EOF
          
          # Create desktop entry
          cat > "$PACKAGE_NAME/usr/share/applications/centra.desktop" << EOF
          [Desktop Entry]
          Name=Centra
          Comment=Payroll and HR Management
          Exec=/usr/local/bin/centra/centra
          Icon=centra
          Terminal=false
          Type=Application
          Categories=Office;Finance;
          EOF
          
          # Build DEB package
          dpkg-deb --build "$PACKAGE_NAME"

      - name: Upload Linux DEB
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: centra_${{ needs.version.outputs.version-number }}-${{ needs.version.outputs.build-number }}_amd64.deb

  build-windows:
    name: Build Windows EXE
    needs: version
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Create Inno Setup Script
        run: |
          $version = "${{ needs.version.outputs.version-number }}"
          $buildNumber = "${{ needs.version.outputs.build-number }}"
          
          @"
          #define MyAppName "Centra"
          #define MyAppVersion "$version"
          #define MyAppPublisher "Erevu Technologies"
          #define MyAppURL "https://github.com/Erevu-Technologies/centra"
          #define MyAppExeName "centra.exe"
          
          [Setup]
          AppId={{CENTRA-APP-GUID}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          DefaultDirName={autopf}\Centra
          DefaultGroupName=Centra
          OutputDir=.
          OutputBaseFilename=centra-v$version-windows-setup
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}";
          
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          
          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -FilePath "installer.iss" -Encoding ASCII

      - name: Build Windows Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: centra-v${{ needs.version.outputs.version-number }}-windows-setup.exe

  release:
    name: Create GitHub Release
    needs: [version, build-android, build-web, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version.outputs.version-number }}
          name: Release v${{ needs.version.outputs.version-number }}
          body: |
            ## Centra Release v${{ needs.version.outputs.version-number }}
            Build Number: ${{ needs.version.outputs.build-number }}
            
            ### üì¶ Downloads
            
            **Android:**
            - `centra-v${{ needs.version.outputs.version-number }}-android.apk` - Install on Android devices
            - `centra-v${{ needs.version.outputs.version-number }}-android.aab` - For Google Play Store
            
            **Web:**
            - `centra-v${{ needs.version.outputs.version-number }}-web.zip` - Extract and deploy to web server
            
            **Linux:**
            - `centra_${{ needs.version.outputs.version-number }}-${{ needs.version.outputs.build-number }}_amd64.deb` - Install with `sudo dpkg -i <file>`
            
            **Windows:**
            - `centra-v${{ needs.version.outputs.version-number }}-windows-setup.exe` - Run installer
            
            ### üìù Changelog
            - Add your release notes here
            
          draft: false
          prerelease: false
          files: |
            artifacts/android-apk/*.apk
            artifacts/android-aab/*.aab
            artifacts/web-build/*.zip
            artifacts/linux-deb/*.deb
            artifacts/windows-installer/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
